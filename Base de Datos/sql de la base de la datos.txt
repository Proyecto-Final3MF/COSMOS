CREATE TABLE rol (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL
);

CREATE TABLE categoria (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL
);

CREATE TABLE usuario (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    contrasena VARCHAR(255) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    foto_perfil VARCHAR(255) DEFAULT 'Assets/imagenes/perfil/fotodefault.webp',
    rol_id INT, FOREIGN KEY (rol_id) REFERENCES rol(id),
    cant_review INT DEFAULT 0,
    promedio DOUBLE DEFAULT 0.0,
    estado_verificacion ENUM('pendiente', 'aprobado', 'rechazado') NOT NULL DEFAULT 'aprobado',
    otra_especialidad VARCHAR(255) NULL,
    evidencia_tecnica_ruta VARCHAR(255) NULL
);

CREATE TABLE producto (
    id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(255) NOT NULL,
    imagen VARCHAR(255) NOT NULL,
    id_cat INT NOT NULL, FOREIGN KEY (id_cat) REFERENCES categoria(id),
    id_usuario INT NOT NULL, FOREIGN KEY (id_usuario) REFERENCES usuario(id),
    disponible TINYINT(1) NOT NULL DEFAULT 1
);

CREATE TABLE estado(
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL
);

CREATE TABLE solicitud (
    id INT AUTO_INCREMENT PRIMARY KEY,
    titulo VARCHAR(200) NOT NULL,
    cliente_id INT NOT NULL, FOREIGN KEY (cliente_id) REFERENCES usuario(id),
    tecnico_id INT NULL, FOREIGN KEY (tecnico_id) REFERENCES usuario(id),
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    prioridad ENUM ('baja', 'media', 'alta', 'urgente') DEFAULT 'media',
    producto_id INT NOT NULL, FOREIGN KEY (producto_id) REFERENCES producto(id),
    estado_id INT, FOREIGN KEY (estado_id) REFERENCES estado(id),
    descripcion TEXT NOT NULL
);

CREATE TABLE historial (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario VARCHAR(100),
    usuario_id INT,
    accion VARCHAR(100),
    item VARCHAR(100),
    item_id INT,
    fecha_hora timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    obs VARCHAR(255)
);

CREATE TABLE mensaje (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL,
    receptor_id INT NULL,
    mensaje TEXT NOT NULL,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE historia_solicitud (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_solicitud INT, FOREIGN KEY (id_solicitud) REFERENCES solicitud(id),
    evento VARCHAR (255),
    fecha_hora TIMESTAMP
);

CREATE TABLE notificacion (
    id INT AUTO_INCREMENT PRIMARY KEY,
    usuario_id INT NOT NULL, 
    mensaje TEXT NOT NULL,
    leida TINYINT(1) DEFAULT 0, 
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuario(id)
);

CREATE TABLE reviews (
    id INT PRIMARY KEY AUTO_INCREMENT,
    id_solicitud INT, FOREIGN KEY (id_solicitud) REFERENCES solicitud(id),
    id_tecnico INT, FOREIGN KEY (id_tecnico) REFERENCES usuario(id),
    id_cliente INT, FOREIGN KEY (id_cliente) REFERENCES usuario(id),
    comentario VARCHAR(255),
    rating DOUBLE,
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_edicion DATETIME ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE especializacion (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE usuario_especializacion (
    usuario_id INT NOT NULL,
    especializacion_id INT NOT NULL,
    PRIMARY KEY (usuario_id, especializacion_id),
    FOREIGN KEY (usuario_id) REFERENCES usuario(id) ON DELETE CASCADE,
    FOREIGN KEY (especializacion_id) REFERENCES especializacion(id) ON DELETE CASCADE
);

INSERT INTO `estado` (`id`, `nombre`) VALUES
(1, 'Disponible'), 
(2, 'En diagnostico'), 
(3, 'En espera de repuestos'), 
(4, 'En reparacion'), 
(5, 'Finalizado');

INSERT INTO `rol` (`id`, `nombre`) VALUES 
(1, 'Tecnico'), 
(2, 'Cliente'), 
(3, 'Admin');

INSERT INTO `usuario` (`id`, `nombre`, `contrasena`, `email`, `foto_perfil`, `rol_id`, `cant_review`, `promedio`) VALUES 
(1, 'Admin', '$2y$10$JiS.f45VhIlHDq/jxfcz.e3wuA8nHGy2ok3cXC3vYzTgb5/Kmjp6W', 'admin@gmail.com', 'Assets/imagenes/perfil/fotodefault.webp', 3, 0, 0);

INSERT INTO `categoria` (`id`, `nombre`) VALUES
(1, 'Laptop'),
(2, 'Celular'),
(3, 'Televisión'),
(4, 'Monitor'),
(5, 'Impresora'),
(6, 'Consola de Videojuegos'),
(7, 'Router/Módem'),
(8, 'Smartwatch'),
(9, 'Cámara Digital'),
(10, 'Disco Duro Externo');

INSERT INTO `especializacion` (`id`, `nombre`) VALUES
(1, 'Reparación de Laptops'),
(2, 'Servicio Técnico de Celulares'),
(3, 'Diagnóstico de Televisores'),
(4, 'Mantenimiento de Monitores'),
(5, 'Reparación de Impresoras'),
(6, 'Consolas y Gaming'),
(7, 'Redes y Conectividad (Router/Módem)'),
(8, 'Dispositivos Wearable (Smartwatch)'),
(9, 'Equipos de Fotografía Digital'),
(10, 'Recuperación y Almacenamiento de Datos (HDD/SSD)');